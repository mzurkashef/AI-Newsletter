name: Weekly AI Newsletter

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:  # Allow manual triggering from GitHub Actions UI

jobs:
  generate-newsletter:
    name: Generate and Deliver Newsletter
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2 hour timeout to stay within budget

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create environment file
        run: |
          cat > .env << EOF
          TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}
          AI_SERVICE_TYPE=${{ secrets.AI_SERVICE_TYPE }}
          AI_API_KEY=${{ secrets.AI_API_KEY }}
          AI_MODEL_PATH=${{ secrets.AI_MODEL_PATH }}
          EOF

      - name: Create config files
        run: |
          mkdir -p config
          cat > config/sources.yaml << 'EOF'
          newsletters:
            - name: "Superhuman AI"
              url: "https://superhuman.ai/newsletter"
            - name: "The Rundown AI"
              url: "https://www.therundown.ai"
            - name: "Axios AI"
              url: "https://www.axios.com/newsletters/axios-ai"
            - name: "Import AI"
              url: "https://importai.substack.com"
            - name: "Jack's Reading List"
              url: "https://jack.substack.com"

          youtube_channels:
            - name: "Yannic Kilcher"
              channel_id: "UCZHmQbKrH_ts2v67l1VkcFQ"
            - name: "Jeremy Howard"
              channel_id: "UCVHFbqXqoYvEV38v9JelJDg"
            - name: "Andrej Karpathy"
              channel_id: "UCXUPKJO5KX3TSZ07QKR-CEO"
          EOF

      - name: Create filtering config
        run: |
          cat > config/filters.yaml << 'EOF'
          # Keywords that indicate major announcements
          breakthrough_keywords:
            - "breakthrough"
            - "major announcement"
            - "release"
            - "new model"
            - "sota"
            - "state-of-the-art"
            - "achieve"
            - "surpass"
            - "exceeds"
            - "outperforms"
            - "disruption"
            - "revolutionary"

          # Negative indicators (filter these out)
          exclude_keywords:
            - "opinion"
            - "rumor"
            - "allegedly"
            - "might"
            - "could be"
            - "speculation"

          # Minimum word count for summaries
          min_summary_words: 20
          max_summary_words: 150
          EOF

      - name: Create AI config
        run: |
          cat > config/ai_config.yaml << 'EOF'
          # AI Content Filtering Configuration
          filter_config:
            threshold_major_announcement: 0.7
            threshold_significant_development: 0.6
            min_content_length: 100

          # Summary generation
          summary_config:
            max_tokens: 150
            temperature: 0.7

          # Categorization
          category_config:
            num_categories: 3
            min_category_size: 2
          EOF

      - name: Log execution start
        run: echo "Starting newsletter generation at $(date -u +'%Y-%m-%d %H:%M:%S UTC')"

      - name: Run newsletter generation
        run: |
          python src/main.py \
            --config-dir config \
            --log-level INFO \
            --output-format markdown

      - name: Log execution completion
        run: echo "Newsletter generation completed at $(date -u +'%Y-%m-%d %H:%M:%S UTC')"

      - name: Upload logs (on success)
        if: success()
        uses: actions/upload-artifact@v3
        with:
          name: newsletter-logs-success
          path: logs/
          retention-days: 7

      - name: Upload logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: newsletter-logs-failure
          path: logs/
          retention-days: 30

      - name: Create failure notification
        if: failure()
        run: |
          echo "::notice title=Newsletter Generation Failed::The newsletter generation failed. Check the logs for details."

      - name: Send failure notification to Telegram
        if: failure()
        continue-on-error: true
        run: |
          python << 'EOF'
          import os
          import requests
          from datetime import datetime

          bot_token = os.getenv('TELEGRAM_BOT_TOKEN')
          chat_id = os.getenv('TELEGRAM_CHAT_ID')

          if bot_token and chat_id:
              message = f"""
          ⚠️ Newsletter Generation Failed

          Date: {datetime.utcnow().isoformat()}

          The automated newsletter generation encountered an error.
          Please check the GitHub Actions logs for details.

          Workflow: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
              """

              try:
                  requests.post(
                      f"https://api.telegram.org/bot{bot_token}/sendMessage",
                      json={
                          "chat_id": int(chat_id),
                          "text": message,
                          "parse_mode": "HTML"
                      },
                      timeout=10
                  )
              except Exception as e:
                  print(f"Failed to send error notification: {e}")
          EOF

  # Clean up old workflow runs
  cleanup:
    name: Cleanup Old Runs
    runs-on: ubuntu-latest
    needs: generate-newsletter
    if: always()

    steps:
      - name: Delete old workflow runs
        uses: actions/github-script@v6
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const workflow_id = 'newsletter.yml';
            const keep_runs = 10;

            try {
              const runs = await github.rest.actions.listWorkflowRuns({
                owner,
                repo,
                workflow_id,
                per_page: 100
              });

              const run_ids = runs.data.workflow_runs
                .map(run => run.id)
                .slice(keep_runs);

              for (const run_id of run_ids) {
                try {
                  await github.rest.actions.deleteWorkflowRun({
                    owner,
                    repo,
                    run_id
                  });
                  console.log(`Deleted workflow run ${run_id}`);
                } catch (e) {
                  console.warn(`Failed to delete run ${run_id}: ${e.message}`);
                }
              }
            } catch (e) {
              console.warn(`Failed to cleanup runs: ${e.message}`);
            }
